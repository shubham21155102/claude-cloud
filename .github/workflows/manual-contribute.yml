name: Manual Contribution

on:
  workflow_dispatch:
    inputs:
      org:
        description: 'Organization or username'
        required: true
        type: string
      repo:
        description: 'Repository name'
        required: true
        type: string
      issue:
        description: 'Issue description'
        required: true
        type: string

jobs:
  contribute:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout claude-cloud
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: |
          npm install
          npm install -g @anthropic-ai/claude-code
          npm link

      - name: Configure Claude Cloud
        env:
          GH_USERNAME: ${{ secrets.GH_USERNAME }}
          GH_EMAIL: ${{ secrets.GH_EMAIL }}
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          ZAI_API_KEY: ${{ secrets.ZAI_API_KEY }}
        run: |
          # Create the config file manually in the home directory
          cat <<EOF > $HOME/.claude-cloud-config.json
          {
            "githubUsername": "$GH_USERNAME",
            "githubEmail": "$GH_EMAIL",
            "githubToken": "$GH_TOKEN",
            "zaiApiKey": "$ZAI_API_KEY",
            "workDir": "$GITHUB_WORKSPACE/temp_repos"
          }
          EOF

      - name: Run Contribution
        env:
          # Set the Z.AI model mapping
          ANTHROPIC_DEFAULT_OPUS_MODEL: GLM-4.7
          # Pass issue via environment variable to avoid shell quoting issues
          CLAUDE_CLOUD_ISSUE: ${{ inputs.issue }}
        run: |
          echo "ðŸš€ Starting contribution to ${{ inputs.org }}/${{ inputs.repo }}..."
          claude-cloud contribute --org "${{ inputs.org }}" --repo "${{ inputs.repo }}"
