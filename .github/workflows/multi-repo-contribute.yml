name: Multi-Repository Contribution

on:
  workflow_dispatch:
    inputs:
      repos:
        description: 'Repositories to work on (format: owner/repo,owner/repo,...)'
        required: true
        type: string
      issue:
        description: 'Issue description'
        required: true
        type: string
      show_logs:
        description: 'Show Claude Code logs (default: false)'
        required: false
        type: boolean
        default: false

  repository_dispatch:
    types: [multi-repo-trigger]

jobs:
  preprocess:
    runs-on: ubuntu-latest
    outputs:
      repos_matrix: ${{ steps.convert-matrix.outputs.matrix }}
    steps:
      - name: Convert repos to matrix format
        id: convert-matrix
        run: |
          REPOS_INPUT="${{ inputs.repos || github.event.client_payload.repos }}"
          echo "Received input: $REPOS_INPUT"

          # Convert comma-separated to JSON array format
          # Input: "owner1/repo1,owner2/repo2" or "[owner1/repo1,owner2/repo2]"
          # Output: [{"repo":"owner1/repo1"},{"repo":"owner2/repo2"}]

          # Remove brackets if present
          REPOS_CLEAN=$(echo "$REPOS_INPUT" | sed 's/^\[//' | sed 's/\]$//')

          # Split by comma and build JSON array
          MATRIX_JSON="["
          FIRST=true
          IFS=','
          for repo in $REPOS_CLEAN; do
            # Trim whitespace
            repo=$(echo "$repo" | xargs)
            if [ -n "$repo" ]; then
              if [ "$FIRST" = true ]; then
                MATRIX_JSON="${MATRIX_JSON}{\"repo\":\"${repo}\"}"
                FIRST=false
              else
                MATRIX_JSON="${MATRIX_JSON},{\"repo\":\"${repo}\"}"
              fi
            fi
          done
          MATRIX_JSON="${MATRIX_JSON}]"

          echo "Generated matrix: $MATRIX_JSON"
          echo "matrix=$MATRIX_JSON" >> $GITHUB_OUTPUT

  contribute:
    runs-on: ubuntu-latest
    needs: preprocess
    strategy:
      matrix:
        repo: ${{ fromJSON(needs.preprocess.outputs.repos_matrix) }}
      fail-fast: false
      max-parallel: 3

    steps:
      - name: Checkout claude-cloud
        uses: actions/checkout@v4

      - name: Parse repository info
        id: parse-repo
        run: |
          REPO_STRING="${{ matrix.repo }}"
          # Remove quotes if present
          REPO_STRING=$(echo "$REPO_STRING" | tr -d '"'\''')
          # Trim whitespace
          REPO_STRING=$(echo "$REPO_STRING" | xargs)
          # Split by /
          ORG_NAME=$(echo "$REPO_STRING" | cut -d'/' -f1 | xargs)
          REPO_NAME=$(echo "$REPO_STRING" | cut -d'/' -f2 | xargs)

          # Validate that we got both parts
          if [ -z "$ORG_NAME" ] || [ -z "$REPO_NAME" ]; then
            echo "âŒ Error: Invalid repository format '$REPO_STRING'"
            echo "Expected format: owner/repo"
            exit 1
          fi

          # Check for invalid characters
          if echo "$ORG_NAME" | grep -q '[,\s]' || echo "$REPO_NAME" | grep -q '[,\s]'; then
            echo "âŒ Error: Repository name contains invalid characters (commas or spaces)"
            echo "Organization: $ORG_NAME"
            echo "Repository: $REPO_NAME"
            exit 1
          fi

          echo "org=$ORG_NAME" >> $GITHUB_OUTPUT
          echo "repo=$REPO_NAME" >> $GITHUB_OUTPUT
          echo "âœ… Processing repository: $ORG_NAME/$REPO_NAME"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: |
          npm install
          npm install -g @anthropic-ai/claude-code
          npm link

      - name: Configure Claude Cloud
        env:
          GH_USERNAME: ${{ secrets.GH_USERNAME }}
          GH_EMAIL: ${{ secrets.GH_EMAIL }}
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          ZAI_API_KEY: ${{ secrets.ZAI_API_KEY }}
        run: |
          # Create the config file manually in the home directory
          cat <<EOF > $HOME/.claude-cloud-config.json
          {
            "githubUsername": "$GH_USERNAME",
            "githubEmail": "$GH_EMAIL",
            "githubToken": "$GH_TOKEN",
            "zaiApiKey": "$ZAI_API_KEY",
            "workDir": "$GITHUB_WORKSPACE/temp_repos"
          }
          EOF

      - name: Run Contribution
        env:
          # Set the Z.AI model mapping
          ANTHROPIC_DEFAULT_OPUS_MODEL: GLM-4.7
          # Use parsed repository information
          ORG_NAME: ${{ steps.parse-repo.outputs.org }}
          REPO_NAME: ${{ steps.parse-repo.outputs.repo }}
          # Pass issue via environment variable to avoid shell quoting issues
          CLAUDE_CLOUD_ISSUE: ${{ github.event.client_payload.issue || inputs.issue }}
          # Control whether to show Claude Code logs
          CLAUDE_CLOUD_SHOW_LOGS: ${{ github.event.client_payload.show_logs == true || inputs.show_logs == true && 'true' || 'false' }}
        run: |
          echo "ðŸš€ Starting contribution to $ORG_NAME/$REPO_NAME..."
          echo "ðŸ“‹ Show logs: $CLAUDE_CLOUD_SHOW_LOGS"
          claude-cloud contribute --org "$ORG_NAME" --repo "$REPO_NAME"

      - name: Upload Claude logs (if they exist)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: claude-logs-${{ github.run_id }}-${{ steps.parse-repo.outputs.org }}-${{ steps.parse-repo.outputs.repo }}
          path: ${{ github.workspace }}/temp_repos/${{ steps.parse-repo.outputs.org }}_${{ steps.parse-repo.outputs.repo }}/.claude-logs.txt
          if-no-files-found: ignore
