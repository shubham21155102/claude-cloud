name: Manual Contribution Along With Streaming

on:
  workflow_dispatch:
    inputs:
      org:
        description: 'Organization or username'
        required: true
        type: string
      repo:
        description: 'Repository name'
        required: true
        type: string
      issue:
        description: 'Issue description'
        required: true
        type: string
      show_logs:
        description: 'Show Claude Code logs (default: false)'
        required: false
        type: boolean
        default: false

jobs:
  contribute:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout claude-cloud
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: |
          npm install
          npm install -g @anthropic-ai/claude-code
          npm link

      - name: Configure Claude Cloud
        env:
          GH_USERNAME: ${{ secrets.GH_USERNAME }}
          GH_EMAIL: ${{ secrets.GH_EMAIL }}
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          ZAI_API_KEY: ${{ secrets.ZAI_API_KEY }}
        run: |
          # Create the config file manually in the home directory
          cat <<EOF > $HOME/.claude-cloud-config.json
          {
            "githubUsername": "$GH_USERNAME",
            "githubEmail": "$GH_EMAIL",
            "githubToken": "$GH_TOKEN",
            "zaiApiKey": "$ZAI_API_KEY",
            "workDir": "$GITHUB_WORKSPACE/temp_repos"
          }
          EOF

      - name: Run Contribution
        env:
          # Set the Z.AI model mapping
          ANTHROPIC_DEFAULT_OPUS_MODEL: GLM-4.7
          # Pass issue via environment variable
          CLAUDE_CLOUD_ISSUE: ${{ inputs.issue }}
          # Control whether to show Claude Code logs
          CLAUDE_CLOUD_SHOW_LOGS: ${{ inputs.show_logs == true && 'true' || 'false' }}
          # Force Node.js to disable TTY colors and interactive behavior
          FORCE_COLOR: 0
          # Provide the API Key directly as a fallback
          ANTHROPIC_API_KEY: ${{ secrets.ZAI_API_KEY }}
        run: |
          echo "ðŸš€ Starting contribution to ${{ inputs.org }}/${{ inputs.repo }}..."
          echo "ðŸ“‹ Show logs setting: $CLAUDE_CLOUD_SHOW_LOGS"

          # 1. Use 'unbuffer' (expect) if available, or stdbuf, to force stream
          # 2. Set NODE_OPTIONS to force no-TTY mode
          # 3. Add --yes to auto-confirm prompts

          export NODE_OPTIONS="--no-warnings"

          # We execute the command, piping stderr to stdout immediately
          # We add --yes to prevent the tool from hanging on interactive prompts
          stdbuf -o0 -e0 claude-cloud contribute --org "${{ inputs.org }}" --repo "${{ inputs.repo }}" --yes 2>&1

      - name: Upload Claude logs (if they exist)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: claude-logs-${{ github.run_id }}
          path: ${{ github.workspace }}/temp_repos/*/.claude-logs.txt
          if-no-files-found: ignore
